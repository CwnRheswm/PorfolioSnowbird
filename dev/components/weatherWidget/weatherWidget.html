<link rel="import" href="../polymer/polymer.html">

<polymer-element name="weather-widget">
	<template>
		<link rel="stylesheet" href="weatherWidget.css">
		<div class="weatherMobileWidget">
			<div class="leftCol">
				<div class="mtnCam">MTN CAM</div>
				<ul>
					<li><span>24 hr</span><span>0&#8221</span></li>
					<li><span>48 hr</span><span>0&#8221</span></li>
					<li><span>Depth</span><span>0&#8221</span></li>
					<li><span>YTD</span><span>0&#8221</span></li>
				</ul>
				<button>Mtn Report</button>
			</div>
			<div class="rightCol">
				<div class="currentTemp">
					<span class='icon'></span>
					<span class='temp'>46<span><sup>&deg</sup></span></span>
				</div>
				<ul>
				</ul>
			</div>
		</div>
	</template>
	<script>

		Polymer('weather-widget',{
			ready: function(){
		
        	weather = (function(){

                _getWeatherFromOWM = function(){
                    if(!isDebug){
                        //url parts
                        var weatherArray = {
                            "today":"",
                            "forecast":""
                        },
                        units = arguments.units || "metric",
                        city = arguments.city || "snowbird, UT",
                        forecastDays = arguments.forcastDays || "5",
                        weatherKey='2a875b5c2a61bdb14dc7f2af6876cf7b',
                        url = "http://api.openweathermap.org/data/2.5/",
                        //weather = ,
                        args = "?q=" +
                                city + "&cnt=" +
                                forcastDays + "&mode=json&units=" +
                                units + "&callback=?&APPID=" +
                                weatherKey;
                        //forecast/daily instead of weather

                        callService = function(url, success){
                            var ud = '_'+new Date(),
                            script = document.createElement('script'),
                            head = $('#head')[0] || document.documentElement;
                        
                            window[ud] = function(data){
                                head.removeChild(script);
                                success && success(data);
                            };

                            script.src = url.replace('callback=?', 'callback='+ud);
                            
                            head.appendChild(script);
                        };
                        callService((url + "weather" + args), function(data){
                            weatherArray.today = data;
                            callService((url + "forecast/daily" + args), function(data){
                                weatherArray.forecast = data;
                                return weatherArray;
                            });
                        });
                    }
                    else{
                        fauxWeather = ({ "coord":{"lon":-0.13,"lat":51.51},
                            /*"current":{"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],
                            "main":{"temp":5,"pressure":1018,"humidity":61,"temp_min":14,"temp_max":1},
                            "wind":{"speed":10.3,"deg":290,"gust":15.4}},*/
                            "forecast":{"0":{"weather":[{"id":800, //weather.id
                                "main":"Clear", //weather.main
                                "description":"sky is clear", //weather.description
                                "icon":"10n"}], //weather.icon
                                "main":{"temp":12.73, //temp.day
                                    "pressure":814.36, //pressure
                                    "humidity":61, //humidity
                                    "temp_min":0, //temp.min
                                    "temp_max":15.22}, //temp.max
                                "wind":{"speed":10.3, //speed
                                    "deg":290,  //deg
                                    "gust":15.4},
                                },
                                "1":{"weather":[{"id":500, //weather.id
                                "main":"Rain", //weather.main
                                "description":"light rain", //weather.description
                                "icon":"10n"}], //weather.icon
                                "main":{"temp":12.73, //temp.day
                                    "pressure":814.36, //pressure
                                    "humidity":61, //humidity
                                    "temp_min":1, //temp.min
                                    "temp_max":11.46}, //temp.max
                                "wind":{"speed":10.3, //speed
                                    "deg":290,  //deg
                                    "gust":15.4},
                                },
                                "2":{"weather":[{"id":800, //weather.id
                                "main":"Clear", //weather.main
                                "description":"sky is clear", //weather.description
                                "icon":"01n"}], //weather.icon
                                "main":{"temp":12.73, //temp.day
                                    "pressure":814.36, //pressure
                                    "humidity":61, //humidity
                                    "temp_min":4.11, //temp.min
                                    "temp_max":14.78}, //temp.max
                                "wind":{"speed":10.3, //speed
                                    "deg":290,  //deg
                                    "gust":15.4},
                                },
                                "3":{"weather":[{"id":500, //weather.id
                                "main":"Rain", //weather.main
                                "description":"light rain", //weather.description
                                "icon":"10n"}], //weather.icon
                                "main":{"temp":14.64, //temp.day
                                    "pressure":814.36, //pressure
                                    "humidity":61, //humidity
                                    "temp_min":4.11, //temp.min
                                    "temp_max":14.64}, //temp.max
                                "wind":{"speed":10.3, //speed
                                    "deg":290,  //deg
                                    "gust":15.4},
                                },
                                "4":{"weather":[{"id":802, //weather.id
                                "main":"Rain", //weather.main
                                "description":"light rain", //weather.description
                                "icon":"10n"}], //weather.icon
                                "main":{"temp":9, //temp.day
                                    "pressure":814.36, //pressure
                                    "humidity":61, //humidity
                                    "temp_min":2, //temp.min
                                    "temp_max":9}, //temp.max
                                "wind":{"speed":10.3, //speed
                                    "deg":290,  //deg
                                    "gust":15.4},
                                }
                            },
                            "name":"London",
                            "dateSet":new Date()
                        });
                        return fauxWeather;
                    }
                },
                _parseOWMIcon = function(iconCode){
                    //parse iconCode, return class string to add to class
                    var icon = [];
                    
                    switch(iconCode.substr(0,2)){
                        
                        case '02':
                        case '03':
                            icon.push("partlyCloudy");
                            break;
                        case '04':
                        case '50':
                            icon.push("cloudy");
                            break;
                        case '09':
                        case '10':
                        case '11':
                            icon.push("rain");
                            break;
                        case '13':
                            icon.push("snow");
                            break;
                        //case "01":
                        default:
                            icon.push("clear");
                            break;
                    }
                    switch(iconCode.substr(2,1)){
                        case "n":
                            icon.push("night");
                            break;
                        //case "d":
                        default:
                            break;
                    }
                    //};
                    //else{icon = " snow"};
                    /*
                    01 = clear,
                    02, 03 = partly_cloudy,
                    04, 50 = cloudy,
                    09, 10, 11 = rain,
                    13 = snow;
                    */
                    return icon; //return string of classes to add to icon class
                },
                _getWeather = function(){ //returns JSON object of current/forecast weather data
                    //pull weather from local storage, return JSON
                    var storedWeather = sessionStorage.weatherObject;
                    if(storedWeather !== undefined){
                        if(storedWeather.dateSet.getTime() > (today.getTime() + 43200000)){
                            
                            return _getWeatherFromOWM();
                            
                            //JSON.parse()
                        } else {
                            return storedWeather;
                            //return _getWeatherFromOWM();
                        }
                    }
                    return _getWeatherFromOWM();
                },
                _setWeather = function(weatherCondition,date){ 
                    var weekday = ["sun","mon","tue","wed","thu","fri","sat"],
                    day = today.getDay(),
                    dayObj = {"day":"","icon":"","high":"","low":"","temp":""};

                    if(weatherCondition){
                        //set weather parameters (INDIVIDUAL/group)?
                        //"date":"weather":{"icon"},"main":{"temp","temp_min","temp_max"}
                        if(date > -1){
                            day += date;
                            if(day > 6){
                                day-=7;
                            }
                            dayObj.day = weekday[day];
                        }
                        
                        dayObj.icon = _parseOWMIcon(weatherCondition.weather[0].icon);
                        dayObj.high = weatherCondition.main.temp_max;
                        dayObj.low = weatherCondition.main.temp_min;
                        dayObj.temp = weatherCondition.main.temp;
                        return dayObj;
                    }
                },
                _storeWeather = function(weatherObject){
                    //store weather array/JSON in localstorage
                    //localStorage.setItem("weatherObject", JSON.stringify(weatherObject) );
                    sessionStorage.setItem("weatherObject", JSON.stringify(weatherObject));
                };

                return{getWeather: _getWeather,
                       setWeather: _setWeather,
                       storeWeather: _storeWeather};
            }());

            }
        });

	</script>
</polymer-element>

<!--
<div class="weatherMobileWidget">
	<div class="leftCol">
		<div class="mtnCam">MTN CAM</div>
		<ul>
			<li><span>24 hr</span><span>0&#8221</span></li>
			<li><span>48 hr</span><span>0&#8221</span></li>
			<li><span>Depth</span><span>0&#8221</span></li>
			<li><span>YTD</span><span>0&#8221</span></li>
		</ul>
		<button>Mtn Report</button>
	</div>
	<div class="rightCol">
		<div class="currentTemp">
			<span class='icon'></span>
			<span class='temp'>46<span><sup>&deg</sup></span></span>
		</div>
		<ul>
		</ul>
	</div>
</div>
-->